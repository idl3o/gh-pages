<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Packaging Emscripten | Project Documentation Hub</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Packaging Emscripten" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Central documentation for TypeScript SDK, Smart Contracts, RED X Backend, and Serverless Functions" />
<meta property="og:description" content="Central documentation for TypeScript SDK, Smart Contracts, RED X Backend, and Serverless Functions" />
<link rel="canonical" href="/docs/packaging.html" />
<meta property="og:url" content="/docs/packaging.html" />
<meta property="og:site_name" content="Project Documentation Hub" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Packaging Emscripten" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Central documentation for TypeScript SDK, Smart Contracts, RED X Backend, and Serverless Functions","headline":"Packaging Emscripten","url":"/docs/packaging.html"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/css/main.css">
  
</head>
<body>
  


  <div class="container-lg px-3 my-5 markdown-body">
    
    <!-- prettier-ignore-start -->
    <h1><a href="/">Project Documentation Hub</a></h1>
    <!-- prettier-ignore-end -->
    

    <article class="post">

  <header class="post-header">
    <h1 class="post-title">Packaging Emscripten</h1>
  </header>

  <div class="post-content">
    <h1 id="packaging-emscripten">Packaging Emscripten</h1>

<p>This document is designed to aid in packaging emscripten.  For example within
linux distributions, or other downstream SDKs.</p>

<p>Firstly, we provide an install script in <code class="language-plaintext highlighter-rouge">tools/install.py</code>.  This allows
just the end-user parts of emscripten to be installed.  For example this avoids
including the <code class="language-plaintext highlighter-rouge">test/third_party</code> directory which is one of the biggest parts
of the source tree.</p>

<p>If you prefer, you can use <code class="language-plaintext highlighter-rouge">make install</code> or <code class="language-plaintext highlighter-rouge">make dist</code> which invokes
<code class="language-plaintext highlighter-rouge">tools/install.py</code>.</p>

<h2 id="dependencies">Dependencies</h2>

<p>One important thing to note here is that emscripten doesn’t currently support
the stable LLVM releases.  It requires a build of LLVM from top-of-tree, or at
least very close to it.  This means that depending on a packaged version of LLVM
is unlikely to work.</p>

<p>The core
<a href="https://chromium.googlesource.com/emscripten-releases/+/refs/heads/master/DEPS">DEPS</a>
file in the <code class="language-plaintext highlighter-rouge">emscripten-releases</code> repository contains all the information about
the various repositories that go into an emscripten release. These are the repos
used by our CI to build and test emscripten.  To find out which revisions went
into a given release you need to check out the DEPS file that the revision
corresponding to that release.  It has lines like these:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  'binaryen_revision': '06698d7a32cb4eeb24fea942e83d1b15e86a73e6',
  'emscripten_revision': '7224b7930ec2a6abca332300e247619e1aea1719',
  'llvm_project_revision': '33ef687d94604aeb73bedbcf3050524465a3439f',
</code></pre></div></div>

<p>These lines specify git hashes of the various repositories that make up the
release.</p>

<p>In principle you can build any git hash in that repo because all updates get
fully tested before they are committed. You can look at the
<a href="https://ci.chromium.org/p/emscripten-releases/g/main/console">CI UI</a> to see
if our CI shows green for any hash, and if so, it should be safe to build.</p>

<p>Alternatively, you may want to build our official emscripten release tags, which
are the versions the emsdk lets users install. To find the mapping between the
emsdk versions and the revision of the emscripten-releases repository, the emsdk
has
<a href="https://github.com/emscripten-core/emsdk/blob/main/emscripten-releases-tags.json">emscripten-releases-tags.json</a>.
All versions listed there should be safe to build, as we check that the CI
was green on them.</p>

<p>To see how our CI builds things, the relevant script is
<a href="https://github.com/WebAssembly/waterfall/blob/master/src/build.py">build.py</a>.
In general, the repos you need to build are LLVM and Binaryen (as emscripten
itself doesn’t have any binaries to build).</p>

<p>When packaging build results, you need the following executables:</p>

<ul>
  <li>From LLVM:
    <ul>
      <li>clang</li>
      <li>clang++ (note: this is a symlink to clang)</li>
      <li>wasm-ld</li>
      <li>llc</li>
      <li>llvm-nm</li>
      <li>llvm-ar</li>
      <li>llvm-as</li>
      <li>llvm-dis</li>
      <li>llvm-link</li>
      <li>llvm-dwarfdump</li>
    </ul>
  </li>
  <li>From Binaryen:
    <ul>
      <li>wasm-emscripten-finalize</li>
      <li>wasm-opt</li>
      <li>wasm-dis</li>
      <li>wasm-as</li>
      <li>wasm2js</li>
      <li>wasm-metadce</li>
    </ul>
  </li>
</ul>

<h2 id="node-modules">Node modules</h2>

<p>In addition to the dependencies listed above, emscripten also has node module
dependencies specified in <code class="language-plaintext highlighter-rouge">package.json</code>.  These should be be installed by
running <code class="language-plaintext highlighter-rouge">npm install</code> inside the emscripten directory.</p>

<p>This will create a <code class="language-plaintext highlighter-rouge">node_modules</code> subdirectory containing the required
dependencies.  This directory should be packaged along with emscripten.  We
don’t currently support these modules being installed in other locations but
supporting system-wide node modules is something that could be added if it is
deemed useful.</p>

<h2 id="configuration">Configuration</h2>

<p>For most distributions it will make sense to ship a configuration file along
with emscripten.  If you don’t do this then emscripten will attempt to guide the
user through the configuration process on first use, which is likely
undesirable in the packaged environment.</p>

<p>We suggest you ship a <code class="language-plaintext highlighter-rouge">.emscripten</code> configuration file inside the emscripten
directory itself.  Emscripten will look here first before looking for
<code class="language-plaintext highlighter-rouge">~/.emscripten</code>.</p>

<p>The key configuration setting are requires are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">LLVM_ROOT</code>: The path to the LLVM binaries.</li>
  <li><code class="language-plaintext highlighter-rouge">BINARYEN_ROOT</code>: The path to binaryen (the binaries are expected in <code class="language-plaintext highlighter-rouge">/bin</code>
under there; note that despite the name this differs from <code class="language-plaintext highlighter-rouge">LLVM_ROOT</code> which
points directly to the binaries).</li>
  <li><code class="language-plaintext highlighter-rouge">NODE_JS</code>: The path to the node.js executable. This is needed internally.</li>
</ul>

<h2 id="ports">Ports</h2>

<p>If you package emscripten and don’t want the ports system to be used, you can
simply delete the <code class="language-plaintext highlighter-rouge">tools/ports/</code> directory.</p>

<h2 id="prebuilt-libraries">Prebuilt libraries</h2>

<p>Ideally a packaged installation can include a fully populated cache directory
containing pre-built libraries.  If you want to do this you can use
<code class="language-plaintext highlighter-rouge">embuilder build ALL</code> to populate the cache directory.  You can then ship the
<code class="language-plaintext highlighter-rouge">cache</code> directory inside the emscripten directory.  When shipping the cache
directory on a multi-user system where users cannot modify the <code class="language-plaintext highlighter-rouge">cache</code> you need
to be sure that all possible configurations of the libraries are built.
Currently that means running:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>embuilder build ALL
embuilder build ALL --lto
embuilder build ALL --pic
embuilder build ALL --pic --lto
</code></pre></div></div>

<h2 id="existing-packages">Existing Packages</h2>

<p>See https://emscripten.org/docs/getting_started/downloads.html#installation-using-packages</p>

  </div>

</article>


    
    <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
      <!-- Removed github_edit_link tag -->
    </div>
    
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
  <script>anchors.add();</script>
</body>
</html>
