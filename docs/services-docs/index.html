<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Integration Services Documentation | Project Documentation Hub</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Integration Services Documentation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Central documentation for TypeScript SDK, Smart Contracts, RED X Backend, and Serverless Functions" />
<meta property="og:description" content="Central documentation for TypeScript SDK, Smart Contracts, RED X Backend, and Serverless Functions" />
<link rel="canonical" href="/docs/services-docs/" />
<meta property="og:url" content="/docs/services-docs/" />
<meta property="og:site_name" content="Project Documentation Hub" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Integration Services Documentation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Central documentation for TypeScript SDK, Smart Contracts, RED X Backend, and Serverless Functions","headline":"Integration Services Documentation","url":"/docs/services-docs/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/css/main.css">
  
</head>
<body>
  


  <div class="container-lg px-3 my-5 markdown-body">
    
    <!-- prettier-ignore-start -->
    <h1><a href="/">Project Documentation Hub</a></h1>
    <!-- prettier-ignore-end -->
    

    <h1 id="integration-services-documentation">Integration Services Documentation</h1>

<p>This documentation covers our integration services which connect various components of the platform, including blockchain data services, email services, HLS streaming services, and IPFS decentralized storage.</p>

<h2 id="overview">Overview</h2>

<p>Our integration services act as bridges between different components of the platform, ensuring seamless communication and data flow between the blockchain, web services, storage systems, and communication channels.</p>

<h2 id="key-services">Key Services</h2>

<h3 id="blockchain-data-service">Blockchain Data Service</h3>

<p>The Blockchain Data Service provides real-time access to blockchain data, including token balances, transaction history, and payment stream status.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// BlockchainDataService.js</span>
<span class="kd">class</span> <span class="nx">BlockchainDataService</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">contracts</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">provider</span> <span class="o">=</span> <span class="nx">provider</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">contracts</span> <span class="o">=</span> <span class="nx">contracts</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ethers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ethers</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">getTokenBalance</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">tokenAddress</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tokenContract</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">ethers</span><span class="p">.</span><span class="nx">Contract</span><span class="p">(</span>
      <span class="nx">tokenAddress</span><span class="p">,</span>
      <span class="p">[</span><span class="dl">'</span><span class="s1">function balanceOf(address) view returns (uint256)</span><span class="dl">'</span><span class="p">],</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">provider</span>
    <span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">tokenContract</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">getPaymentStreamDetails</span><span class="p">(</span><span class="nx">streamId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">contracts</span><span class="p">.</span><span class="nx">paymentStream</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Payment stream contract not initialized</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">contracts</span><span class="p">.</span><span class="nx">paymentStream</span><span class="p">.</span><span class="nx">getStream</span><span class="p">(</span><span class="nx">streamId</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">getTransactionHistory</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">startBlock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">endBlock</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">latest</span><span class="dl">'</span><span class="p">,</span> <span class="nx">limit</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    
    <span class="kd">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">getHistory</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">startBlock</span><span class="p">,</span> <span class="nx">endBlock</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">history</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">limit</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">BlockchainDataService</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="usage-example">Usage Example</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">ethers</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ethers</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">BlockchainDataService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./services/BlockchainDataService</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">PaymentStreamABI</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./abis/PaymentStream.json</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Initialize provider</span>
<span class="kd">const</span> <span class="nx">provider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">JsonRpcProvider</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://mainnet.infura.io/v3/your-project-id</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Initialize contracts</span>
<span class="kd">const</span> <span class="nx">paymentStreamContract</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">Contract</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">0xPaymentStreamContractAddress</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">PaymentStreamABI</span><span class="p">,</span>
  <span class="nx">provider</span>
<span class="p">);</span>

<span class="c1">// Initialize service</span>
<span class="kd">const</span> <span class="nx">blockchainService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlockchainDataService</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">paymentStream</span><span class="p">:</span> <span class="nx">paymentStreamContract</span>
<span class="p">});</span>

<span class="c1">// Get token balance</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">getUserTokenBalance</span><span class="p">(</span><span class="nx">userAddress</span><span class="p">,</span> <span class="nx">tokenAddress</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">balance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">blockchainService</span><span class="p">.</span><span class="nx">getTokenBalance</span><span class="p">(</span><span class="nx">userAddress</span><span class="p">,</span> <span class="nx">tokenAddress</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Balance: </span><span class="p">${</span><span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">formatEther</span><span class="p">(</span><span class="nx">balance</span><span class="p">)}</span><span class="s2"> tokens`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">balance</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed to fetch token balance:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="email-service">Email Service</h3>

<p>The Email Service handles transactional emails, notifications, and marketing communications.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// emailService.js</span>
<span class="kd">const</span> <span class="nx">nodemailer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">nodemailer</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">handlebars</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">handlebars</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">class</span> <span class="nx">EmailService</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transporter</span> <span class="o">=</span> <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">transportOptions</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">defaultFrom</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">defaultFrom</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">templateDir</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">templateDir</span> <span class="o">||</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../email-templates</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">loadTemplate</span><span class="p">(</span><span class="nx">templateName</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">templatePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templateDir</span><span class="p">,</span> <span class="s2">`</span><span class="p">${</span><span class="nx">templateName</span><span class="p">}</span><span class="s2">.html`</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">templateSource</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">templatePath</span><span class="p">,</span> <span class="dl">'</span><span class="s1">utf-8</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">templateSource</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">template</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">templateName</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="k">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultFrom</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    
    <span class="kd">let</span> <span class="nx">html</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">templateName</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">html</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadTemplate</span><span class="p">(</span><span class="nx">templateName</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">html</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Either templateName or html must be provided</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">const</span> <span class="nx">mailOptions</span> <span class="o">=</span> <span class="p">{</span>
      <span class="k">from</span><span class="p">,</span>
      <span class="nx">to</span><span class="p">,</span>
      <span class="nx">subject</span><span class="p">,</span>
      <span class="nx">html</span><span class="p">,</span>
      <span class="na">text</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">text</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">htmlToText</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span>
    <span class="p">};</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="nx">htmlToText</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Simple HTML to text conversion</span>
    <span class="k">return</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;</span><span class="se">[^</span><span class="sr">&gt;</span><span class="se">]</span><span class="sr">*&gt;/g</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">sendWelcomeEmail</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">({</span>
      <span class="na">to</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">subject</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Welcome to our platform!</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">templateName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">welcome</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="na">verificationLink</span><span class="p">:</span> <span class="s2">`https://example.com/verify?token=</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">verificationToken</span><span class="p">}</span><span class="s2">`</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">sendPaymentConfirmation</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">payment</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">({</span>
      <span class="na">to</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">subject</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Payment Confirmation</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">templateName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">payment-confirmation</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="na">amount</span><span class="p">:</span> <span class="nx">payment</span><span class="p">.</span><span class="nx">amount</span><span class="p">,</span>
        <span class="na">date</span><span class="p">:</span> <span class="nx">payment</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
        <span class="na">transactionId</span><span class="p">:</span> <span class="nx">payment</span><span class="p">.</span><span class="nx">transactionId</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">EmailService</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="usage-example-1">Usage Example</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">EmailService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./services/emailService</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">emailService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EmailService</span><span class="p">({</span>
  <span class="na">transportOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">host</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_HOST</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_PORT</span><span class="p">,</span>
    <span class="na">secure</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_USER</span><span class="p">,</span>
      <span class="na">pass</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_PASSWORD</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">defaultFrom</span><span class="p">:</span> <span class="dl">'</span><span class="s1">"Platform" &lt;noreply@example.com&gt;</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Send a welcome email</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">sendUserWelcome</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">sendWelcomeEmail</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Welcome email sent:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">messageId</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed to send welcome email:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="hls-streaming-service">HLS Streaming Service</h3>

<p>The HLS (HTTP Live Streaming) Service manages adaptive bitrate streaming for media content.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// HLSService.js</span>
<span class="kd">const</span> <span class="nx">ffmpeg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fluent-ffmpeg</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">class</span> <span class="nx">HLSService</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">outputDir</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">outputDir</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">segmentLength</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">segmentLength</span> <span class="o">||</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// seconds</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">qualities</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">qualities</span> <span class="o">||</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">720p</span><span class="dl">'</span><span class="p">,</span> <span class="na">resolution</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1280x720</span><span class="dl">'</span><span class="p">,</span> <span class="na">bitrate</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2500k</span><span class="dl">'</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">480p</span><span class="dl">'</span><span class="p">,</span> <span class="na">resolution</span><span class="p">:</span> <span class="dl">'</span><span class="s1">854x480</span><span class="dl">'</span><span class="p">,</span> <span class="na">bitrate</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1000k</span><span class="dl">'</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">360p</span><span class="dl">'</span><span class="p">,</span> <span class="na">resolution</span><span class="p">:</span> <span class="dl">'</span><span class="s1">640x360</span><span class="dl">'</span><span class="p">,</span> <span class="na">bitrate</span><span class="p">:</span> <span class="dl">'</span><span class="s1">500k</span><span class="dl">'</span> <span class="p">}</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">createHLSStream</span><span class="p">(</span><span class="nx">videoPath</span><span class="p">,</span> <span class="nx">outputName</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Create output directory</span>
    <span class="kd">const</span> <span class="nx">streamDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outputDir</span><span class="p">,</span> <span class="nx">outputName</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">streamDir</span><span class="p">,</span> <span class="p">{</span> <span class="na">recursive</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    
    <span class="c1">// Create master playlist</span>
    <span class="kd">let</span> <span class="nx">masterPlaylist</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">#EXTM3U</span><span class="se">\n</span><span class="dl">'</span><span class="p">;</span>
    
    <span class="c1">// Process each quality variant</span>
    <span class="kd">const</span> <span class="nx">transcodePromises</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">qualities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">quality</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">qualityDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">streamDir</span><span class="p">,</span> <span class="nx">quality</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">qualityDir</span><span class="p">,</span> <span class="p">{</span> <span class="na">recursive</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
      
      <span class="kd">const</span> <span class="nx">playlistPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">qualityDir</span><span class="p">,</span> <span class="dl">'</span><span class="s1">playlist.m3u8</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">segmentPattern</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">qualityDir</span><span class="p">,</span> <span class="dl">'</span><span class="s1">segment%d.ts</span><span class="dl">'</span><span class="p">);</span>
      
      <span class="c1">// Add to master playlist</span>
      <span class="nx">masterPlaylist</span> <span class="o">+=</span> <span class="s2">`#EXT-X-STREAM-INF:BANDWIDTH=</span><span class="p">${</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">quality</span><span class="p">.</span><span class="nx">bitrate</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">}</span><span class="s2">,RESOLUTION=</span><span class="p">${</span><span class="nx">quality</span><span class="p">.</span><span class="nx">resolution</span><span class="p">}</span><span class="s2">\n`</span><span class="p">;</span>
      <span class="nx">masterPlaylist</span> <span class="o">+=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">quality</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">/playlist.m3u8\n`</span><span class="p">;</span>
      
      <span class="c1">// Transcode video</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">ffmpeg</span><span class="p">(</span><span class="nx">videoPath</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">outputOptions</span><span class="p">([</span>
            <span class="s2">`-c:v libx264`</span><span class="p">,</span>
            <span class="s2">`-c:a aac`</span><span class="p">,</span>
            <span class="s2">`-b:v </span><span class="p">${</span><span class="nx">quality</span><span class="p">.</span><span class="nx">bitrate</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
            <span class="s2">`-s </span><span class="p">${</span><span class="nx">quality</span><span class="p">.</span><span class="nx">resolution</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
            <span class="s2">`-hls_time </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">segmentLength</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
            <span class="s2">`-hls_playlist_type vod`</span><span class="p">,</span>
            <span class="s2">`-hls_segment_filename </span><span class="p">${</span><span class="nx">segmentPattern</span><span class="p">}</span><span class="s2">`</span>
          <span class="p">])</span>
          <span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="nx">playlistPath</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">run</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
    
    <span class="c1">// Wait for all transcoding processes to complete</span>
    <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">transcodePromises</span><span class="p">);</span>
    
    <span class="c1">// Write master playlist</span>
    <span class="kd">const</span> <span class="nx">masterPlaylistPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">streamDir</span><span class="p">,</span> <span class="dl">'</span><span class="s1">master.m3u8</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">masterPlaylistPath</span><span class="p">,</span> <span class="nx">masterPlaylist</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">masterPlaylist</span><span class="p">:</span> <span class="s2">`/streams/</span><span class="p">${</span><span class="nx">outputName</span><span class="p">}</span><span class="s2">/master.m3u8`</span><span class="p">,</span>
      <span class="na">variants</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">qualities</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">q</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">quality</span><span class="p">:</span> <span class="nx">q</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="na">playlist</span><span class="p">:</span> <span class="s2">`/streams/</span><span class="p">${</span><span class="nx">outputName</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">q</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">/playlist.m3u8`</span>
      <span class="p">}))</span>
    <span class="p">};</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">generateThumbnail</span><span class="p">(</span><span class="nx">videoPath</span><span class="p">,</span> <span class="nx">outputName</span><span class="p">,</span> <span class="nx">time</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">00:00:05</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">thumbnailDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outputDir</span><span class="p">,</span> <span class="nx">outputName</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">thumbnailDir</span><span class="p">,</span> <span class="p">{</span> <span class="na">recursive</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    
    <span class="kd">const</span> <span class="nx">thumbnailPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">thumbnailDir</span><span class="p">,</span> <span class="dl">'</span><span class="s1">thumbnail.jpg</span><span class="dl">'</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">ffmpeg</span><span class="p">(</span><span class="nx">videoPath</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">screenshots</span><span class="p">({</span>
          <span class="na">timestamps</span><span class="p">:</span> <span class="p">[</span><span class="nx">time</span><span class="p">],</span>
          <span class="na">filename</span><span class="p">:</span> <span class="dl">'</span><span class="s1">thumbnail.jpg</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">folder</span><span class="p">:</span> <span class="nx">thumbnailDir</span><span class="p">,</span>
          <span class="na">size</span><span class="p">:</span> <span class="dl">'</span><span class="s1">320x180</span><span class="dl">'</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="s2">`/streams/</span><span class="p">${</span><span class="nx">outputName</span><span class="p">}</span><span class="s2">/thumbnail.jpg`</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">HLSService</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="usage-example-2">Usage Example</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">HLSService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./services/HLSService</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">hlsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HLSService</span><span class="p">({</span>
  <span class="na">outputDir</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../public/streams</span><span class="dl">'</span><span class="p">),</span>
  <span class="na">segmentLength</span><span class="p">:</span> <span class="mi">6</span> <span class="c1">// 6 seconds per segment</span>
<span class="p">});</span>

<span class="c1">// Process a video for streaming</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">processVideoForStreaming</span><span class="p">(</span><span class="nx">videoPath</span><span class="p">,</span> <span class="nx">streamId</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Processing video for streaming: </span><span class="p">${</span><span class="nx">streamId</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    
    <span class="c1">// Generate stream</span>
    <span class="kd">const</span> <span class="nx">streamDetails</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">hlsService</span><span class="p">.</span><span class="nx">createHLSStream</span><span class="p">(</span><span class="nx">videoPath</span><span class="p">,</span> <span class="nx">streamId</span><span class="p">);</span>
    
    <span class="c1">// Generate thumbnail</span>
    <span class="kd">const</span> <span class="nx">thumbnailUrl</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">hlsService</span><span class="p">.</span><span class="nx">generateThumbnail</span><span class="p">(</span><span class="nx">videoPath</span><span class="p">,</span> <span class="nx">streamId</span><span class="p">);</span>
    
    <span class="c1">// Return stream metadata</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">streamId</span><span class="p">,</span>
      <span class="na">masterPlaylist</span><span class="p">:</span> <span class="nx">streamDetails</span><span class="p">.</span><span class="nx">masterPlaylist</span><span class="p">,</span>
      <span class="na">variants</span><span class="p">:</span> <span class="nx">streamDetails</span><span class="p">.</span><span class="nx">variants</span><span class="p">,</span>
      <span class="na">thumbnail</span><span class="p">:</span> <span class="nx">thumbnailUrl</span>
    <span class="p">};</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Failed to process video for streaming: </span><span class="p">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ipfs-service">IPFS Service</h3>

<p>The IPFS (InterPlanetary File System) Service provides decentralized storage capabilities for content and metadata.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// IPFSService.js</span>
<span class="kd">const</span> <span class="nx">ipfsClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ipfs-http-client</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">Buffer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">buffer</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">class</span> <span class="nx">IPFSService</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ipfs</span> <span class="o">=</span> <span class="nx">ipfsClient</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">ipfsApiUrl</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gateway</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">gateway</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">uploadFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">uploadBuffer</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">uploadBuffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ipfs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">cid</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">cid</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
      <span class="na">size</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">gateway</span><span class="p">}</span><span class="s2">/ipfs/</span><span class="p">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">cid</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2">`</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">uploadJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">uploadBuffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">uploadDirectory</span><span class="p">(</span><span class="nx">directoryPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getFilesFromDirectory</span><span class="p">(</span><span class="nx">directoryPath</span><span class="p">);</span>
    
    <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">file</span> <span class="k">of</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="na">path</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">content</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ipfs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="p">{</span> <span class="na">wrapWithDirectory</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">cid</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">cid</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
      <span class="na">size</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">gateway</span><span class="p">}</span><span class="s2">/ipfs/</span><span class="p">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">cid</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2">`</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">getFilesFromDirectory</span><span class="p">(</span><span class="nx">directoryPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">entries</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">directoryPath</span><span class="p">,</span> <span class="p">{</span> <span class="na">withFileTypes</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    
    <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">entries</span>
      <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">entry</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nx">entry</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entry</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="na">path</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">directoryPath</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
      <span class="p">}));</span>
    
    <span class="k">return</span> <span class="nx">files</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">getIPFSUrl</span><span class="p">(</span><span class="nx">cid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">gateway</span><span class="p">}</span><span class="s2">/ipfs/</span><span class="p">${</span><span class="nx">cid</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">pinCID</span><span class="p">(</span><span class="nx">cid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ipfs</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">cid</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">unpinCID</span><span class="p">(</span><span class="nx">cid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ipfs</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">cid</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">IPFSService</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="usage-example-3">Usage Example</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">IPFSService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./services/IPFSService</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">ipfsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IPFSService</span><span class="p">({</span>
  <span class="na">ipfsApiUrl</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">IPFS_API_URL</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">http://localhost:5001</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">gateway</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">IPFS_GATEWAY</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">https://gateway.ipfs.io</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Upload content metadata to IPFS</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">uploadContentMetadata</span><span class="p">(</span><span class="nx">metadata</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Uploading content metadata to IPFS</span><span class="dl">'</span><span class="p">);</span>
    
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ipfsService</span><span class="p">.</span><span class="nx">uploadJSON</span><span class="p">(</span><span class="nx">metadata</span><span class="p">);</span>
    
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Metadata uploaded to IPFS with CID: </span><span class="p">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">cid</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`IPFS URL: </span><span class="p">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    
    <span class="c1">// Pin the content to ensure persistence</span>
    <span class="k">await</span> <span class="nx">ipfsService</span><span class="p">.</span><span class="nx">pinCID</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">cid</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Failed to upload metadata to IPFS: </span><span class="p">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="service-integration-patterns">Service Integration Patterns</h2>

<p>Our integration services follow several design patterns to ensure reliability, scalability, and maintainability:</p>

<h3 id="1-dependency-injection">1. Dependency Injection</h3>

<p>Services are designed with dependency injection to facilitate testing and configuration:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Dependency injection example</span>
<span class="kd">function</span> <span class="nx">createServices</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">provider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">JsonRpcProvider</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">rpcUrl</span><span class="p">);</span>
  
  <span class="c1">// Create contracts</span>
  <span class="kd">const</span> <span class="nx">paymentStreamContract</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">Contract</span><span class="p">(</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">contractAddresses</span><span class="p">.</span><span class="nx">paymentStream</span><span class="p">,</span>
    <span class="nx">PaymentStreamABI</span><span class="p">,</span>
    <span class="nx">provider</span>
  <span class="p">);</span>
  
  <span class="c1">// Create services</span>
  <span class="kd">const</span> <span class="nx">blockchainService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlockchainDataService</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">paymentStream</span><span class="p">:</span> <span class="nx">paymentStreamContract</span>
  <span class="p">});</span>
  
  <span class="kd">const</span> <span class="nx">emailService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EmailService</span><span class="p">({</span>
    <span class="na">transportOptions</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">transportOptions</span><span class="p">,</span>
    <span class="na">defaultFrom</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">defaultFrom</span>
  <span class="p">});</span>
  
  <span class="kd">const</span> <span class="nx">ipfsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IPFSService</span><span class="p">({</span>
    <span class="na">ipfsApiUrl</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ipfs</span><span class="p">.</span><span class="nx">apiUrl</span><span class="p">,</span>
    <span class="na">gateway</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ipfs</span><span class="p">.</span><span class="nx">gateway</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">blockchainService</span><span class="p">,</span>
    <span class="nx">emailService</span><span class="p">,</span>
    <span class="nx">ipfsService</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="2-event-driven-architecture">2. Event-Driven Architecture</h3>

<p>Services communicate through events to ensure loose coupling:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Event-driven example</span>
<span class="kd">const</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">events</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">class</span> <span class="nx">ServiceBus</span> <span class="kd">extends</span> <span class="nx">EventEmitter</span> <span class="p">{}</span>

<span class="kd">const</span> <span class="nx">serviceBus</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ServiceBus</span><span class="p">();</span>

<span class="c1">// Subscribe to payment events</span>
<span class="nx">serviceBus</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">payment.created</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">payment</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getUserById</span><span class="p">(</span><span class="nx">payment</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">sendPaymentConfirmation</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">payment</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Subscribe to stream events</span>
<span class="nx">serviceBus</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">stream.started</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Update blockchain record</span>
  <span class="k">await</span> <span class="nx">blockchainService</span><span class="p">.</span><span class="nx">recordStreamStart</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Emit events</span>
<span class="kd">function</span> <span class="nx">createPayment</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Process payment</span>
  <span class="kd">const</span> <span class="nx">payment</span> <span class="o">=</span> <span class="nx">processPayment</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">);</span>
  
  <span class="c1">// Emit event</span>
  <span class="nx">serviceBus</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">payment.created</span><span class="dl">'</span><span class="p">,</span> <span class="nx">payment</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="nx">payment</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="3-retry-mechanisms">3. Retry Mechanisms</h3>

<p>Services implement retry logic for resilience:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Retry mechanism example</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">withRetry</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">maxRetries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">delay</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="nx">backoff</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  
  <span class="kd">let</span> <span class="nx">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">currentDelay</span> <span class="o">=</span> <span class="nx">delay</span><span class="p">;</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">await</span> <span class="nx">fn</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">retries</span><span class="o">++</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">retries</span> <span class="o">&gt;=</span> <span class="nx">maxRetries</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">currentDelay</span><span class="p">));</span>
      <span class="nx">currentDelay</span> <span class="o">*=</span> <span class="nx">backoff</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Usage</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">getStreamData</span><span class="p">(</span><span class="nx">streamId</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">withRetry</span><span class="p">(</span>
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">blockchainService</span><span class="p">.</span><span class="nx">getPaymentStreamDetails</span><span class="p">(</span><span class="nx">streamId</span><span class="p">),</span>
    <span class="p">{</span> <span class="na">maxRetries</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="na">delay</span><span class="p">:</span> <span class="mi">2000</span> <span class="p">}</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="configuration">Configuration</h2>

<p>Services are configured through environment variables and configuration files:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// config.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">rpcUrl</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RPC_URL</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">http://localhost:8545</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">contractAddresses</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">paymentStream</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PAYMENT_STREAM_ADDRESS</span><span class="p">,</span>
    <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TOKEN_ADDRESS</span>
  <span class="p">},</span>
  <span class="na">email</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">transportOptions</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">host</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_HOST</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_PORT</span><span class="p">,</span>
      <span class="na">secure</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_SECURE</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">user</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_USER</span><span class="p">,</span>
        <span class="na">pass</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SMTP_PASSWORD</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">defaultFrom</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_FROM</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">"Platform" &lt;noreply@example.com&gt;</span><span class="dl">'</span>
  <span class="p">},</span>
  <span class="na">ipfs</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">apiUrl</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">IPFS_API_URL</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">http://localhost:5001</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">gateway</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">IPFS_GATEWAY</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">https://gateway.ipfs.io</span><span class="dl">'</span>
  <span class="p">},</span>
  <span class="na">hls</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">outputDir</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HLS_OUTPUT_DIR</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">./public/streams</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">segmentLength</span><span class="p">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HLS_SEGMENT_LENGTH</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">10</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="next-steps">Next Steps</h2>

<ul>
  <li><a href="/docs/server-docs/">Server Documentation</a></li>
  <li><a href="/docs/serverless-docs/">Serverless Functions Documentation</a></li>
  <li><a href="/docs/utility-docs/">Utility Documentation</a></li>
</ul>


    
    <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
      <!-- Removed github_edit_link tag -->
    </div>
    
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
  <script>anchors.add();</script>
</body>
</html>
